## âš™ï¸ **6.4.2 â€“ Chat Model & Schema**

### ğŸ¯ Goal

Persist conversation history per user session â€” allowing:

- Fetching all previous sessions (for sidebar/history view)
- Restoring messages to LLM memory on resume
- Handling multi-user (future-ready)

---

## ğŸ§© **Schema Design Overview**

Weâ€™ll have **two collections**:

1. **`ChatSession`** â†’ metadata about a conversation
2. **`Message`** â†’ actual message content linked to a session

```
ChatSession
 â”œâ”€â”€ id: ObjectId
 â”œâ”€â”€ userId: string (future: from auth)
 â”œâ”€â”€ title: string
 â”œâ”€â”€ createdAt, updatedAt
 â””â”€â”€ messages: [MessageId] (optional denormalized view)

Message
 â”œâ”€â”€ id: ObjectId
 â”œâ”€â”€ sessionId: ObjectId (ref ChatSession)
 â”œâ”€â”€ role: 'user' | 'assistant' | 'system'
 â”œâ”€â”€ content: string
 â”œâ”€â”€ createdAt
```

---

### ğŸ—ƒï¸ `models/message.model.ts`

```ts
import mongoose, { Schema, Document } from 'mongoose'

export interface IMessage extends Document {
  sessionId: mongoose.Types.ObjectId
  role: 'user' | 'assistant' | 'system'
  content: string
  createdAt: Date
}

const messageSchema = new Schema<IMessage>(
  {
    sessionId: { type: Schema.Types.ObjectId, ref: 'ChatSession', required: true },
    role: { type: String, enum: ['user', 'assistant', 'system'], required: true },
    content: { type: String, required: true },
  },
  { timestamps: { createdAt: true, updatedAt: false } },
)

export const MessageModel = mongoose.model<IMessage>('Message', messageSchema)
```

---

### ğŸ’¬ `models/chatSession.model.ts`

```ts
import mongoose, { Schema, Document } from 'mongoose'

export interface IChatSession extends Document {
  userId?: string
  title: string
  createdAt: Date
  updatedAt: Date
}

const chatSessionSchema = new Schema<IChatSession>(
  {
    userId: { type: String },
    title: { type: String, required: true },
  },
  { timestamps: true },
)

export const ChatSessionModel = mongoose.model<IChatSession>('ChatSession', chatSessionSchema)
```

---

### ğŸ§  Example Document

#### ChatSession

```json
{
  "_id": "670b245d1acdb522f44a97b0",
  "userId": "user-123",
  "title": "Explain event loops",
  "createdAt": "2025-10-12T11:30:00Z",
  "updatedAt": "2025-10-12T11:35:10Z"
}
```

#### Message

```json
{
  "_id": "670b24b11acdb522f44a97b1",
  "sessionId": "670b245d1acdb522f44a97b0",
  "role": "assistant",
  "content": "The event loop allows JavaScript to handle async tasks efficiently...",
  "createdAt": "2025-10-12T11:31:00Z"
}
```

---

### âœ… **Next Step (6.4.3 â€“ Persistence API)**

Weâ€™ll now build a **Chat Controller + Routes** to:

- Create a new session
- Add a message
- List sessions
- Fetch messages for a session

This API will power your frontend chat history and also sync with `BufferMemory`.
