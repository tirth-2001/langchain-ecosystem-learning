# Stage 6.3.2 - Integrate Tools with Agent

## âœ… Clarifications

### **1. Modern Agent Initialization**

You're correct â€” `initializeAgentExecutorWithOptions` is now **deprecated** in the new LangChain agent architecture.
The modern, modular setup uses:

```ts
createToolCallingAgent()
AgentExecutor
ChatPromptTemplate
MessagesPlaceholder
```

This gives you **much better control** over prompts and execution â€” so weâ€™ll build using this pattern.

---

### **2. Integration Point in Your Server Tree**

Based on your current structure:

```
controllers/
â”‚   â”œâ”€â”€ langchain.controller.ts
â”‚   â””â”€â”€ task.controller.ts
routes/
â”‚   â”œâ”€â”€ langchain.routes.ts
â”‚   â””â”€â”€ task.routes.ts
langchain/
â”‚   â”œâ”€â”€ agents/
â”‚   â”œâ”€â”€ chains/
â”‚   â”œâ”€â”€ tools/
```

The **best fit** is:

- Create a new file: `langchain/agents/agentExecutor.ts`
- Add a controller method `runAgent()` in `langchain.controller.ts`
- Wire it under `/api/langchain/agent` route in `langchain.routes.ts`

That keeps all LangChain-related capabilities (ask, taskChain, agent, etc.) together under one namespace.

---

## ðŸ§© Full Integration Plan

### **Step 1 â€“ Create `agentExecutor.ts`**

```ts
// src/langchain/agents/agentExecutor.ts
import { ChatOpenAI } from '@langchain/openai'
import { createToolCallingAgent, AgentExecutor } from 'langchain/agents'
import { ChatPromptTemplate, MessagesPlaceholder } from '@langchain/core/prompts'
import { availableTools } from '../tools'
import { modelProvider } from '../config/modelProvider'

export const createAgentExecutor = async () => {
  // Get the model (from your existing modelProvider.ts)
  const model = modelProvider('gpt-4o-mini')

  // Prepare tools
  const tools = availableTools

  // Define prompt structure
  const prompt = ChatPromptTemplate.fromMessages([
    ['system', 'You are a helpful assistant. Use tools when necessary to provide accurate answers.'],
    ['human', '{input}'],
    new MessagesPlaceholder('agent_scratchpad'),
  ])

  // Create tool-calling agent
  const agent = await createToolCallingAgent({
    llm: model,
    tools,
    prompt,
  })

  // Create executor
  const executor = new AgentExecutor({
    agent,
    tools,
    verbose: true,
  })

  return executor
}
```

---

### **Step 2 â€“ Add Controller Method**

Inside `controllers/langchain.controller.ts`, add:

```ts
import { Request, Response } from 'express'
import { createAgentExecutor } from '../langchain/agents/agentExecutor'
import { successResponse, errorResponse } from '../utils'

export const runAgent = async (req: Request, res: Response) => {
  try {
    const { query } = req.body
    const executor = await createAgentExecutor()
    const result = await executor.invoke({ input: query })

    res.json(successResponse(result))
  } catch (err: any) {
    console.error('Agent error:', err)
    res.status(500).json(errorResponse(err.message))
  }
}
```

---

### **Step 3 â€“ Extend Routes**

Add a new route entry inside `routes/langchain.routes.ts`:

```ts
import express from 'express'
import { runAgent } from '../controllers/langchain.controller'
import { asyncHandler } from '../utils/asyncHandler'

const router = express.Router()

router.post('/agent', asyncHandler(runAgent))

export default router
```

âœ… Now your endpoint will be:

```
POST /api/langchain/agent
Body: { "query": "What's 12*3 and summarize the result?" }
```

---

### **Step 4 â€“ Test Tool Calls**

Example query:

```bash
curl -X POST http://localhost:3000/api/langchain/agent \
  -H "Content-Type: application/json" \
  -d '{"query": "What is the temperature in Delhi and 15 * 4?"}'
```

â†’ The model will:

1. Identify the tools to use (e.g., `weatherTool`, `calculatorTool`)
2. Call them sequentially
3. Return the final, reasoning-backed answer

---

### **Step 5 â€“ (Optional Logging)**

To debug agent reasoning:

```ts
const result = await executor.invoke({ input: query })
console.log('Intermediate Steps:', result.intermediateSteps)
```

---

## âœ… Deliverable Summary

| Item                                    | Description                                            |
| --------------------------------------- | ------------------------------------------------------ |
| **`langchain/agents/agentExecutor.ts`** | Builds modern LangChain agent with tools               |
| **Controller: `runAgent`**              | Express handler for running agent queries              |
| **Route: `/api/langchain/agent`**       | Single entrypoint for all tool-aware queries           |
| **Works With**                          | Existing tools (`calculatorTool`, `weatherTool`, etc.) |
| **Output**                              | Reasoned, tool-enhanced answers                        |
