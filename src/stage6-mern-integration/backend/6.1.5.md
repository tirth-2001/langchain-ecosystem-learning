# **6.1.5 â€“ Middleware & Error Handling**

## ğŸ§­ **Goal of 6.1.5**

Enhance the Express backend with:

1. **Error handling middleware** (centralized)
2. **Request validation & async wrapper**
3. **Logging + CORS**
4. **Rate limiting + security**
5. **Unified API response pattern**

---

## ğŸ“ **Folder structure additions**

Youâ€™ll already have:

```
src/
 â”œâ”€â”€ middleware/
 â”‚   â””â”€â”€ errorHandler.ts
 â”œâ”€â”€ utils/
 â”‚   â””â”€â”€ asyncHandler.ts
 â”‚   â””â”€â”€ apiResponse.ts
 â”œâ”€â”€ app.ts
```

---

## ğŸ§± **1. Unified API Response Utility**

`src/utils/apiResponse.ts`

This helps keep all responses consistent:

```ts
export interface ApiResponse<T = any> {
  success: boolean
  message?: string
  data?: T
  error?: any
}

export const successResponse = <T>(data: T, message?: string): ApiResponse<T> => ({
  success: true,
  message,
  data,
})

export const errorResponse = (error: any, message?: string): ApiResponse => ({
  success: false,
  message,
  error: typeof error === 'string' ? error : error?.message || 'Unknown error',
})
```

---

## âš™ï¸ **2. Async Handler (No More try/catch in Controllers)**

`src/utils/asyncHandler.ts`

```ts
import { Request, Response, NextFunction } from 'express'

export const asyncHandler =
  (fn: (req: Request, res: Response, next: NextFunction) => Promise<any>) =>
  (req: Request, res: Response, next: NextFunction) => {
    Promise.resolve(fn(req, res, next)).catch(next)
  }
```

Usage â†’ wrap any async controller:

```ts
router.post('/', asyncHandler(controller.create))
```

---

## ğŸ§© **3. Error Handling Middleware**

`src/middleware/errorHandler.ts`

```ts
import { Request, Response, NextFunction } from 'express'
import { errorResponse } from '../utils/apiResponse'

export const errorHandler = (err: any, req: Request, res: Response, next: NextFunction) => {
  console.error('ğŸ”¥ Error:', err)

  const status = err.statusCode || 500
  const message = err.message || 'Internal Server Error'

  res.status(status).json(errorResponse(err, message))
}
```

---

## ğŸŒ **4. App-Level Setup (Logging, CORS, Rate Limit)**

Update your `src/app.ts`:

```ts
import express from 'express'
import cors from 'cors'
import morgan from 'morgan'
import rateLimit from 'express-rate-limit'
import bodyParser from 'body-parser'

import routes from './routes'
import { errorHandler } from './middleware/errorHandler'

const app = express()

// Logging
app.use(morgan('dev'))

// CORS setup (adjust for frontend later)
app.use(cors({ origin: '*', methods: ['GET', 'POST', 'DELETE', 'PUT'] }))

// Body parser
app.use(bodyParser.json())

// Rate limiting
const limiter = rateLimit({
  windowMs: 1 * 60 * 1000, // 1 minute
  max: 60, // 60 requests per minute
})
app.use(limiter)

// Routes
app.use('/api', routes)

// Health route
app.get('/api/health', (_, res) => res.json({ success: true, message: 'Server is running âœ…' }))

// Error handler (must be last)
app.use(errorHandler)

export default app
```

---

## ğŸ” **5. Optional Security Add-ons**

Add these only when you move closer to production:

| Library                  | Purpose                       |
| ------------------------ | ----------------------------- |
| `helmet`                 | Adds secure HTTP headers      |
| `express-mongo-sanitize` | Prevents NoSQL injection      |
| `xss-clean`              | Sanitizes user input          |
| `hpp`                    | Prevents HTTP param pollution |

Example:

```bash
yarn add helmet hpp xss-clean express-mongo-sanitize
```

Then add in `app.ts`:

```ts
import helmet from 'helmet'
import hpp from 'hpp'
import xss from 'xss-clean'
import mongoSanitize from 'express-mongo-sanitize'

app.use(helmet())
app.use(hpp())
app.use(xss())
app.use(mongoSanitize())
```

---

## âœ… **6. Example Error Flow**

### Controller before:

```ts
export const create = async (req, res) => {
  const { title } = req.body;
  if (!title) throw new Error("Title is required");
  ...
};
```

### Response:

```json
{
  "success": false,
  "message": "Title is required",
  "error": "Title is required"
}
```

### Controller with success:

```json
{
  "success": true,
  "message": "Task created successfully",
  "data": {
    "id": "...",
    "title": "Summarize",
    "status": "pending"
  }
}
```

---

## ğŸ“‹ **7. Deliverable Summary for 6.1.5**

| Deliverable                     | Description                             |
| ------------------------------- | --------------------------------------- |
| âœ… Unified response format      | `successResponse()` / `errorResponse()` |
| âœ… Async error-safe controllers | `asyncHandler()` wrapper                |
| âœ… Centralized middleware       | `errorHandler.ts`                       |
| âœ… Logging, CORS, rate limiting | For secure, cross-domain API            |
| âœ… Production readiness         | Helmet, sanitization optional           |
